<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Dantepropiedades (Render)</title>
    <style>
        /* ESTILOS B√ÅSICOS */
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .login-container { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .login-box { 
            background: white; padding: 40px; border-radius: 10px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.3); text-align: center;
            width: 300px;
        }
        .hidden { display: none !important; }
        .admin-panel { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .contacto-item { 
            padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; 
            background: #f9f9f9; display: flex; justify-content: space-between; align-items: center;
        }
        .contacto-info { flex: 1; }
        .contacto-actions { display: flex; gap: 10px; }
        .error { color: red; background: #ffe6e6; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .success { color: green; background: #e6ffe6; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .loading { color: #666; font-style: italic; }
        .stats { background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        .modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
            z-index: 2000;
        }
        .modal-content { 
            background: white; padding: 20px; border-radius: 10px; max-width: 500px; width: 90%;
            max-height: 80vh; overflow-y: auto;
        }
        .estado { 
            padding: 3px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; 
        }
        .estado-nuevo { background: #e3f2fd; color: #1976d2; }
        .estado-contactado { background: #fff3e0; color: #f57c00; }
        .estado-interesado { background: #e8f5e8; color: #388e3c; }
        .estado-no_interesado { background: #ffebee; color: #d32f2f; }
        .estado-cerrado { background: #f3e5f5; color: #7b1fa2; }
    </style>
</head>
<body>
    <div class="container">
        <!-- LOGIN SCREEN -->
        <div id="loginScreen" class="login-container">
            <div class="login-box">
                <h2>üîê Acceso de Administrador</h2>
                <p>Ingrese la contrase√±a para acceder al panel</p>
                <input type="password" id="passwordInput" placeholder="Contrase√±a" />
                <button class="btn btn-primary" onclick="iniciarSesion()">Acceder</button>
                <div id="loginError" class="error" style="display: none;"></div>
            </div>
        </div>

        <!-- ADMIN PANEL -->
        <div id="adminPanel" class="admin-panel hidden">
            <h1>üìä Panel de Administraci√≥n - Dantepropiedades</h1>
            <p><strong>üåê Dominio:</strong> dantepropiedades.com.ar | <strong>üîó Backend:</strong> Render.com</p>
            
            <div class="stats">
                <h3>üìà Estad√≠sticas</h3>
                <div id="estadisticas">Cargando estad√≠sticas...</div>
            </div>

            <div style="margin-bottom: 20px;">
                <button class="btn btn-success" onclick="mostrarFormularioNuevo()">‚ûï Agregar Nuevo Contacto</button>
                <button class="btn btn-warning" onclick="refrescarDatos()">üîÑ Refrescar</button>
                <button class="btn btn-danger" onclick="limpiarTodosDatos()">üóëÔ∏è Limpiar Todo</button>
            </div>

            <div id="listaContactos">
                <div class="loading">Cargando contactos...</div>
            </div>
        </div>
    </div>

    <!-- MODAL FORMULARIO -->
    <div id="modalFormulario" class="modal" style="display: none;">
        <div class="modal-content">
            <h3 id="tituloFormulario">Nuevo Contacto</h3>
            <form id="formularioContacto">
                <input type="hidden" id="contactoId" />
                <div>
                    <label>Nombre *</label>
                    <input type="text" id="nombre" required />
                </div>
                <div>
                    <label>Email</label>
                    <input type="email" id="email" />
                </div>
                <div>
                    <label>Tel√©fono</label>
                    <input type="text" id="telefono" />
                </div>
                <div>
                    <label>Estado</label>
                    <select id="estado">
                        <option value="nuevo">Nuevo</option>
                        <option value="contactado">Contactado</option>
                        <option value="interesado">Interesado</option>
                        <option value="no_interesado">No Interesado</option>
                        <option value="cerrado">Cerrado</option>
                    </select>
                </div>
                <div>
                    <label>Notas</label>
                    <textarea id="notas" rows="3"></textarea>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn" onclick="cerrarFormulario()">Cancelar</button>
                    <button type="submit" class="btn btn-success">üíæ Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL VISUALIZAR -->
    <div id="modalVisualizar" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>üëÅÔ∏è Detalles del Contacto</h3>
            <div id="detallesContacto">Cargando...</div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn" onclick="cerrarVisualizar()">Cerrar</button>
                <button class="btn btn-warning" onclick="editarDesdeVisualizar()">‚úèÔ∏è Editar</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN PARA DANTEPROPIEDADES.COM.AR + RENDER
        const ADMIN_PASSWORD = '2205';
        const TOKEN = '2205';
        const BASE_URL = 'https://danterealestate-github-io.onrender.com';

        let contactos = [];
        let contactoSeleccionado = null;

        // Verificar autenticaci√≥n al cargar
        document.addEventListener('DOMContentLoaded', function() {
            const estaAutenticado = sessionStorage.getItem('admin_autenticado') === 'true';
            if (estaAutenticado) {
                mostrarAdmin();
            }
        });

        function iniciarSesion() {
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('loginError');
            
            if (password === ADMIN_PASSWORD) {
                sessionStorage.setItem('admin_autenticado', 'true');
                mostrarAdmin();
            } else {
                errorDiv.textContent = 'Contrase√±a incorrecta';
                errorDiv.style.display = 'block';
            }
        }

        function mostrarAdmin() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminPanel').classList.remove('hidden');
            cargarDatos();
        }

        // Funci√≥n para hacer requests al backend de Render
        async function apiRequest(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data && method !== 'GET') {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`${BASE_URL}/admin/${endpoint}/${TOKEN}`, options);
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error en API request:', error);
                throw error;
            }
        }

        async function cargarDatos() {
            try {
                console.log('üîÑ Cargando datos desde Render...');
                const respuesta = await apiRequest('data');
                
                if (respuesta.success) {
                    contactos = respuesta.data;
                    mostrarContactos();
                    cargarEstadisticas();
                } else {
                    throw new Error(respuesta.error || 'Error cargando datos');
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
                document.getElementById('listaContactos').innerHTML = 
                    `<div class="error">‚ùå Error cargando datos: ${error.message}</div>`;
            }
        }

        function mostrarContactos() {
            const contenedor = document.getElementById('listaContactos');
            
            if (contactos.length === 0) {
                contenedor.innerHTML = '<div class="loading">No hay contactos registrados</div>';
                return;
            }
            
            let html = '<h3>üìã Lista de Contactos (' + contactos.length + ')</h3>';
            
            contactos.forEach(contacto => {
                html += `
                    <div class="contacto-item">
                        <div class="contacto-info">
                            <strong>${contacto.nombre || 'Sin nombre'}</strong><br>
                            <small>üìß ${contacto.email || 'Sin email'} | üì± ${contacto.telefono || 'Sin tel√©fono'}</small><br>
                            <span class="estado estado-${contacto.estado}">${contacto.estado || 'nuevo'}</span>
                        </div>
                        <div class="contacto-actions">
                            <button class="btn" onclick="verContacto('${contacto.timestamp}')">üëÅÔ∏è Ver</button>
                            <button class="btn btn-warning" onclick="editarContacto('${contacto.timestamp}')">‚úèÔ∏è Editar</button>
                            <button class="btn btn-danger" onclick="eliminarContacto('${contacto.timestamp}')">üóëÔ∏è Borrar</button>
                        </div>
                    </div>
                `;
            });
            
            contenedor.innerHTML = html;
        }

        async function cargarEstadisticas() {
            try {
                const stats = await apiRequest('data');
                if (stats.success) {
                    const contactos = stats.data;
                    const total = contactos.length;
                    const nuevos = contactos.filter(c => c.estado === 'nuevo').length;
                    const contactados = contactos.filter(c => c.estado === 'contactado').length;
                    const interesados = contactos.filter(c => c.estado === 'interesado').length;
                    
                    document.getElementById('estadisticas').innerHTML = `
                        <strong>Total:</strong> ${total} | 
                        <strong>Nuevos:</strong> ${nuevos} | 
                        <strong>Contactados:</strong> ${contactados} |
                        <strong>Interesados:</strong> ${interesados}
                    `;
                }
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
            }
        }

        function mostrarFormularioNuevo() {
            document.getElementById('tituloFormulario').textContent = 'Nuevo Contacto';
            document.getElementById('contactoId').value = '';
            document.getElementById('formularioContacto').reset();
            document.getElementById('modalFormulario').style.display = 'flex';
        }

        async function editarContacto(timestamp) {
            try {
                const respuesta = await apiRequest('data');
                const contacto = respuesta.data.find(c => c.timestamp === timestamp);
                
                if (contacto) {
                    document.getElementById('tituloFormulario').textContent = 'Editar Contacto';
                    document.getElementById('contactoId').value = contacto.timestamp;
                    document.getElementById('nombre').value = contacto.nombre || '';
                    document.getElementById('email').value = contacto.email || '';
                    document.getElementById('telefono').value = contacto.telefono || '';
                    document.getElementById('estado').value = contacto.estado || 'nuevo';
                    document.getElementById('notas').value = contacto.notas || '';
                    document.getElementById('modalFormulario').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error editando contacto:', error);
            }
        }

        async function verContacto(timestamp) {
            try {
                const respuesta = await apiRequest('data');
                const contacto = respuesta.data.find(c => c.timestamp === timestamp);
                
                if (contacto) {
                    contactoSeleccionado = contacto;
                    document.getElementById('detallesContacto').innerHTML = `
                        <p><strong>Nombre:</strong> ${contacto.nombre || 'Sin nombre'}</p>
                        <p><strong>Email:</strong> ${contacto.email || 'Sin email'}</p>
                        <p><strong>Tel√©fono:</strong> ${contacto.telefono || 'Sin tel√©fono'}</p>
                        <p><strong>Estado:</strong> ${contacto.estado || 'nuevo'}</p>
                        <p><strong>Notas:</strong> ${contacto.notas || 'Sin notas'}</p>
                        <p><strong>Fecha:</strong> ${contacto.fecha_creacion || 'No disponible'}</p>
                    `;
                    document.getElementById('modalVisualizar').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error visualizando contacto:', error);
            }
        }

        async function eliminarContacto(timestamp) {
            if (!confirm('¬øEst√° seguro de eliminar este contacto?')) {
                return;
            }
            
            try {
                await apiRequest('delete', 'DELETE', { timestamp });
                await cargarDatos();
                alert('‚úÖ Contacto eliminado correctamente');
            } catch (error) {
                console.error('Error eliminando contacto:', error);
                alert('‚ùå Error eliminando contacto');
            }
        }

        function editarDesdeVisualizar() {
            if (contactoSeleccionado) {
                cerrarVisualizar();
                editarContacto(contactoSeleccionado.timestamp);
            }
        }

        function cerrarFormulario() {
            document.getElementById('modalFormulario').style.display = 'none';
        }

        function cerrarVisualizar() {
            document.getElementById('modalVisualizar').style.display = 'none';
            contactoSeleccionado = null;
        }

        async function limpiarTodosDatos() {
            if (!confirm('¬øEst√° seguro de eliminar TODOS los contactos? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            try {
                await apiRequest('clear', 'DELETE');
                await cargarDatos();
                alert('‚úÖ Todos los contactos han sido eliminados');
            } catch (error) {
                console.error('Error limpiando datos:', error);
                alert('‚ùå Error limpiando datos');
            }
        }

        async function refrescarDatos() {
            await cargarDatos();
        }

        // Manejar env√≠o del formulario
        document.getElementById('formularioContacto').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('contactoId').value;
            const datos = {
                nombre: document.getElementById('nombre').value,
                email: document.getElementById('email').value,
                telefono: document.getElementById('telefono').value,
                estado: document.getElementById('estado').value,
                notas: document.getElementById('notas').value
            };
            
            try {
                if (id) {
                    // Editar contacto existente
                    datos.timestamp = id;
                    await apiRequest('update', 'PUT', datos);
                    alert('‚úÖ Contacto actualizado correctamente');
                } else {
                    // Crear nuevo contacto
                    await apiRequest('add', 'POST', datos);
                    alert('‚úÖ Contacto creado correctamente');
                }
                
                cerrarFormulario();
                await cargarDatos();
            } catch (error) {
                console.error('Error guardando contacto:', error);
                alert('‚ùå Error guardando contacto');
            }
        });
    </script>
</body>
</html>